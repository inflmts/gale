#!/bin/sh
#
# gale-open is a drop-in replacement for xdg-open that's designed to be simple
# and explicit. It doesn't read any .desktop files or try to figure out what
# desktop environment it's in. gale-open only matches files by file extension,
# which avoids having to open the file to figure out its type and handles files
# that differ by extension but have the same underlying format.
# Based on this, gale-open launches the appropriate application.

set -ue

progname=${0##*/}

err() { echo >&2 "$progname: $*"; }

usage() {
  cat <<EOF
usage: $progname [options] <file> | <url>

Options:
  -q, --query     print the command that would be run
  -b, --browser   open browser
      --help      show this help
      --version   display version information
EOF
}

# xdg-open is documented not to fork. However, many programs expect xdg-open to
# return immediately, so gale-open always creates a new process.
exec=fork

browser=false

while [ $# -gt 0 ]; do
  case $1 in
    -q|--query)
      exec=query
      ;;
    -b|--browser)
      browser=true
      ;;
    --help)
      usage
      exit 0
      ;;
    --version)
      echo gale-open
      exit 0
      ;;
    -*)
      err "unrecognized option: $1"
      exit 2
      ;;
    *)
      break
      ;;
  esac
  shift
done

if [ $# -ne 1 ]; then
  usage >&2
  exit 2
fi

file=$1

query() {
  echo "$*"
  exit
}

fork() {
  # setsid runs the process in a new session,
  # and detaches from the shell once we exit
  setsid "$@" <&- > /dev/null 2>&1 &
  exit
}

if $browser; then
  $exec chromium "$file"
fi

case ${file%%/*} in
  file:*)
    file=${file#*:}
    ;;
  http:* | https:*)
    $exec chromium "$file"
    ;;
  prismlauncher:*)
    $exec prismlauncher "$file"
    ;;
  steam:*)
    $exec steam "$file"
    ;;
esac

if [ ! -e "$file" ]; then
  err "file does not exist: $file"
  exit 1
fi

if [ -d "$file" ]; then
  $exec foot lf "$file"
fi

ext=${file##*.}

case $ext in
  avif | bmp | gif | jpeg | jpg | png | webp)
    $exec swayimg -- "$file"
    ;;
  flac | mp3 | ogg | opus | wav | avi | mov | mp4 | webm | wmv)
    $exec mpv --player-operation-mode=pseudo-gui -- "$file"
    ;;
  html | md | pdf | svg)
    $exec chromium "$file"
    ;;
  odt | doc | docx)
    $exec lowriter "$file"
    ;;
  odp | ppt | pptx)
    $exec loimpress "$file"
    ;;
  ods | xls | xlsx)
    $exec localc "$file"
    ;;
  aup3)
    $exec audacity "$file"
    ;;
  mmp | mmpz)
    $exec lmms "$file"
    ;;
  *)
    $exec neovide "$file"
    ;;
esac
