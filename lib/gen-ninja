#!/bin/sh
# ninja build file generator

set -e

ninjaq_args() {
  [ "$#" -gt 0 ] && \
  printf '%s\n' "$@" | \
  sed "s/'/'\\\\''/g; s/\\\$/\$\$/g; s/^/'/; s/\$/'/" | \
  tr '\n' ' '
}

ninjaq() {
  printf '%s\n' "$1" | sed 's/\$/$$/g; s/^ /$ /'
}

confdir="${XDG_CONFIG_HOME:-$HOME/.config}/gale"
datadir="${XDG_DATA_HOME:-$HOME/.local/share}/gale"

if [ "$#" -eq 1 ]; then
  rm -f "$1"
  exec > "$1"
fi

cat <<EOF
# Ninja build file for Gale
# automatically generated by gen-ninja

builddir = $(ninjaq "$datadir")

install_mode = 644

# generate a file by running the input file (typically a script) with the
# output file name as the first argument
rule script-arg
  command = \$in \$out

build \$builddir/build.ninja: script-arg .local/gale/lib/gen-ninja
  description = Configure Ninja
  generator = true

build .config/environment.d/gale.conf: script-arg .local/gale/lib/gen-env
  description = Configure systemd Environment
EOF
