#!/bin/sh
# ninja configurator

set -e

ninjaq_args() {
  [ "$#" -gt 0 ] && \
  printf '%s\n' "$@" | \
  sed "s/'/'\\\\''/g; s/\\\$/\$\$/g; s/^/'/; s/\$/'/" | \
  tr '\n' ' '
}

ninjaq() {
  printf '%s\n' "$1" | sed 's/\$/$$/g; s/^ /$ /'
}

confdir="${XDG_CONFIG_HOME:-$HOME/.config}/corecon"
datadir="${XDG_DATA_HOME:-$HOME/.local/share}/corecon"

if [ "$#" -eq 1 ]; then
  rm -f "$1"
  exec > "$1"
fi

cat <<EOF
# apply.ninja for corecon
# automatically generated by gen-ninja
#
corecon_root = .local/corecon
builddir = $(ninjaq "$datadir")

install_mode = 644

rule script
  command = \$in

rule script-arg
  command = \$in \$out

build \$builddir/apply.ninja: script-arg \$corecon_root/lib/gen-ninja
  description = Configure Ninja
  generator = true

build .config/environment.d/corecon.conf: script-arg \$corecon_root/lib/gen-env
  description = Configure systemd Environment
EOF
