#
# ~/.bash_profile
#
# Distributed with corecon
# Author: Daniel Achelon
#

# use vim as editor
export EDITOR=vim

# explicitly specify xdg dirs
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_HOME="$HOME/.data"
export XDG_STATE_HOME="$HOME/.state"
export XDG_CACHE_HOME="$HOME/.cache"

# don't justify man pages
export MANOPT='--nj'

export PATH

# prepend an entry to $PATH
prepend_path() {
  case :"$PATH": in
    *:"$1":*) ;;
    *) PATH="$1:$PATH" ;;
  esac
}

# add standard executable directory
prepend_path ~/.local/bin

unset -f prepend_path

# quit unless interactive
[[ $- != *i* ]] && return

## INTERACTIVE

# automatically run on login
if autologin=$(corecon config --get autologin); then
  case "$autologin" in

    bspwm)
      # Certain conditions must be met for bspwm autostart to commence:
      #
      # - $XDG_RUNTIME_DIR must be set
      # - $XDG_RUNTIME_DIR/did-auto-bspwm (which, if it exists, indicates a
      #     previous execution) must not exist
      # - the `launchx` command must exist
      # - $DISPLAY must not be set
      # - the user must be on a virtual console
      #
      if [[ "$XDG_RUNTIME_DIR" ]] && \
         [[ ! -e "$XDG_RUNTIME_DIR/did-auto-bspwm" ]] && \
         command -v launchx >/dev/null 2>&1 && \
         [[ -z "$DISPLAY" ]] && \
         [[ $(tty) = /dev/tty* ]]
      then
        # create $XDG_RUNTIME_DIR/did-auto-bspwm to prevent future
        # auto-starting
        touch "$XDG_RUNTIME_DIR/did-auto-bspwm"
        exec launchx bspwm
      fi
      ;;

  esac
fi

# dialogmenu
#
#   A login menu using dialog(1).
#
dialogmenu() {
  local resp

  while resp="$(dialog --menu Menu 0 0 0 \
    c 'return to command line' \
    q 'logout' \
    s 'sleep' \
    o 'shutdown' \
    r 'reboot' \
    x 'launch X' \
    3>&1 1>&2 2>&3 3>&-
  )"; do  # ^
          # swap stdout and stderr

    case "$resp" in
      q)
        clear
        exit
        ;;
      s)
        systemctl suspend
        ;;
      o)
        clear
        poweroff
        break
        ;;
      r)
        clear
        reboot
        break
        ;;
      x)
        clear
        launchx bspwm
        ;;
      *)
        clear
        break
        ;;
    esac
  done
}

# CTRL-O opens dialogmenu
bind -m emacs -x '"\C-o":dialogmenu'
bind -m vi-command -x '"\C-o":dialogmenu'
bind -m vi-insert -x '"\C-o":dialogmenu'

# load ~/.bashrc
\. ~/.bashrc

# vim:ft=bash
