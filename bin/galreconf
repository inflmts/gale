#!/bin/sh
# galreconf - generate the update manifest
#
# This file is part of Gale.
#
# This script generates the update manifest, the ninja build file that galupd
# uses to update Gale. This file is at ~/.data/gale/upd.ninja .
#

echo() { printf '%s\n' "$1"; }
diag() { printf >&2 '%s\n' "$1"; }
warn() { printf >&2 'warning: %s\n' "$1"; }
err() { printf >&2 'error: %s\n' "$1"; }

usage()
{
  cat <<EOF
usage: galreconf [<option>...]
options:
  -s, --stdout      print generated manifest to stdout
  -q, --quiet       don't print progress status
      --auto        used internally by galupd
EOF
}

auto=
quiet=
stdout=

for opt; do
  case $opt in
    -h|--help)
      usage
      exit 0
      ;;
    --auto)
      auto=1
      ;;
    -q|--quiet)
      quiet=1
      ;;
    -s|--stdout)
      stdout=1
      ;;
    *)
      err "invalid option: $opt"
      exit 1
      ;;
  esac
done

generate_manifest()
{
  .gale/internal/generate-manifest ${quiet:+--quiet}
}

set -e
cd ~
if [ "$stdout" ]; then
  if [ -t 1 ]; then
    generate_manifest | less -FSMKi
  else
    generate_manifest
  fi
else
  mkdir -p .data/gale
  rm -f .data/gale/upd.ninja.new
  generate_manifest > .data/gale/upd.ninja.new
  mv -T .data/gale/upd.ninja.new .data/gale/upd.ninja
fi
