#!/bin/sh
# galreconf - generate the update manifest
#
# [This file is part of Gale.]
#
#   This script generates the update manifest, the ninja build file that galupd
#   uses to update Gale. This file is at ~/.data/gale/upd.ninja .
#

echo() { printf '%s\n' "$1"; }
diag() { printf >&2 '%s\n' "$1"; }
warn() { printf >&2 'warning: %s\n' "$1"; }
err() { printf >&2 'error: %s\n' "$1"; }

usage() {
  cat <<EOF
usage: galreconf [<option>...]
options:
  -s, --stdout      print generated manifest to stdout
      --auto        used internally by galupd
EOF
}

AUTO=
STDOUT=

for opt; do
  case $opt in
    -h|--help)
      usage
      exit 0
      ;;
    --auto)
      AUTO=1
      ;;
    -s|--stdout)
      STDOUT=1
      ;;
    *)
      err "invalid option: $opt"
      exit 1
      ;;
  esac
done

set -e
cd ~
if [ "$STDOUT" ]; then
  if [ -t 1 ]; then
    .gale/lib/configure | less -FSXMKi
  else
    .gale/lib/configure
  fi
else
  mkdir -p .data/gale
  rm -f .data/gale/upd.ninja.new
  .gale/lib/configure > .data/gale/upd.ninja.new
  mv -T .data/gale/upd.ninja.new .data/gale/upd.ninja
  .gale/bin/galupd -t cleandead
fi
