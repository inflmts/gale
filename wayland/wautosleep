#!/bin/sh
# wayland autosleep using swayidle
#
# [This file is part of Gale.]
#
#   This is a simple front-end to swayidle that puts the computer to sleep after
#   a period of inactivity. It works for any compositor that swayidle supports,
#   ie. those that support the idle protocol. $XDG_RUNTIME_DIR and
#   $WAYLAND_DISPLAY must both be set.
#
# Dependencies:
#   - swayidle <https://github.com/swaywm/swayidle>
#

err() { printf >&2 'error: %s\n' "$1"; }
die() { printf >&2 'error: %s\n' "$1"; exit 1; }
warn() { printf >&2 'warning: %s\n' "$1"; }
echo() { printf '%s\n' "$1"; }

usage() {
  cat <<EOF
usage: wautosleep [<command>]
commands:
     status (default)
  u, up
  r, restart
     restart-running
  d, down
  t, toggle
EOF
}

pidfile() {
  [ "$XDG_RUNTIME_DIR" ] \
    || die '$XDG_RUNTIME_DIR is not set!'
  [ "$WAYLAND_DISPLAY" ] \
    || die '$WAYLAND_DISPLAY is not set!'
  PIDFILE="$XDG_RUNTIME_DIR/wautosleep.$WAYLAND_DISPLAY.pid"
}

wa() {
  stupid --file="$PIDFILE" "$1" swayidle timeout 600 'systemctl suspend'
}

case $1 in
  status|'') pidfile; wa --status ;;
  u|up) pidfile; wa --start ;;
  r|restart) pidfile; wa --restart ;;
  restart-running) pidfile; wa --restart-running ;;
  d|down) pidfile; wa --quit ;;
  t|toggle) pidfile; wa --toggle ;;
  *) usage; exit 1 ;;
esac
